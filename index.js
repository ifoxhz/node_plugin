const libkp = require('./kpgen');



function CsiGenerateKeyProvision() {
	try {
		// 定义相关的 Windows API 函数签名
		// const libraryPath = path.join(__dirname,'libkp_gen.so');
		// console.log(libraryPath)
		// const libkp = ffi.Library(libraryPath, {
		// 	csi_generate_key_provision : [ref.refType(KpType), ['string','string','string','int']]
		// })
		
		let cid = "acfdaa8a7d0d42c9afd31cef77aa99c0"
		let huk = "3B80EC6C7934C102FFFF000000000000"
		let  expect_old =
        "496E44780300000004000100F4000000040020000000000080000000000D00103B00200000000000A0000000FFFFFFFF3E001000000000"+
        "00C0000000FFFFFFFF5000240000000000D0000000FFFFFFFFF7503F42AF6A53908F146211198BCBB6FF785BEE00000000000000000000"+
        "0000000000000000000000000000000000006163666461613861376430643432633961666433316365663737616139396330A108A0D1DD"+
        "180B959A69F47FAAF61819AF02BDBF6001A18A22718C57C3AA240F3B80EC6C7934C102FFFF0000000000001A0400002B615E20E1425E0D"+
        "D38F0643008C0CB564F1853B218DB7E5C220B8B79E19898C0000000000000000000000007B22707269766174654B6579223A2232663838"+
        "32623535306339333234366664646434386264373934623862366432616565633139303262303765653233633838383366373236323131"+
        "6430303537222C2273756363657373223A747275652C226465766963654365727469666963617465223A7B226365727449737375657222"+
        "3A224F50454E415049222C22636F6D70616E79436F6465223A2232303231303033313737363231303336222C22646576696365496E666F"+
        "726D6174696F6E223A7B22646576696365496D6569223A22646576696365496D6569222C226465766963654D6163223A22646576696365"+
        "4D6163222C22646576696365536E223A226163666461613861376430643432633961666433316365663737616139396330227D2C226578"+
        "747261506172616D73223A7B226665617475726573223A5B22414E545F464F5252455354222C225452414E53504F5254222C225041594D"+
        "454E54225D7D2C2270726F647563744D6F64656C223A224C58313030222C2270726F6475637454797065223A225741544348222C227075"+
        "626C69634B6579223A222D2D2D2D2D424547494E205055424C4943204B45592D2D2D2D2D5C6E4D466B77457759484B6F5A497A6A304341"+
        "5159494B6F5A497A6A30444151634451674145316B2F6F6345365649686E664F304F794A654E614E424E3570784C475C6E613252437338"+
        "527567697336303655416E50642B4A543239305859486236784555424961377A4252787654744D4936536F4A4F705651704451673D3D5C"+
        "6E2D2D2D2D2D454E44205055424C4943204B45592D2D2D2D2D5C6E222C2273656375726974794E65676F74696174696F6E223A22454344"+
        "48222C227369676E223A22635965785057326D766D67546D457075554C7555474A4B3856704C67512B6352496C477763597431544C3052"+
        "764178765653462F423864417A2B7363684F3531435173374641634D33646E64442B457A4E447078465A42316B316957336E684D505348"+
        "64504B797375666138347875743764706C4C34446F555438726E2F5954476968336D4B7A73535A622B374A686D364747757A395075334A"+
        "63706542704A4A2F4E624F413632725A656D44654F6C37785642304B42586553756D5A71385573384F5634757666485A305551456E3833"+
        "647753717253646273526D726652346776357A51686C704A5052416B6D304251644C62594A476B733974625354534E7569423638675A44"+
        "5A4A5433424C2B2B4A664D6D322F794533325263644149494A5277484956335965723962347263677A2B32324C54394532454744596A47"+
        "4D656D6C4E374569522B354F4F306949504C73576873773D3D222C227369676E416C676F726974686D223A224241534536345F4F564552"+
        "5F52534132303438222C22736E223A2232303233313032303135303234303232383336353136227D7D";

		let  expect_new =
        "496E44780300000004000100F4000000040020000000000080000000000D00103B00200000000000A0000000FFFFFFFF3E001000000000"+
        "00C0000000FFFFFFFF5000240000000000D0000000FFFFFFFF0EE5AE60446AB15DF55A41FF80871B5C649DA79600000000000000000000"+
        "0000000000000000000000000000000000006163666461613861376430643432633961666433316365663737616139396330A108A0D1DD"+
        "180B959A69F47FAAF61819AF02BDBF6001A18A22718C57C3AA240F3B80EC6C7934C102FFFF000000000000CA030000F5645C5D5A10635B"+
        "C9147EDDBA33ECCA2D0FB367FD2829758C7B3E869411D5BA0000000000000000000000002F882B550C93246FDDD48BD794B8B6D2AEEC19"+
        "02B07EE23C8883F726211D0057DD7E3305C7F796F98229A44F974EED976A9491F617CF32C61D548CCF7A1F59817B227375636365737322"+
        "3A747275652C226465766963654365727469666963617465223A7B2263657274497373756572223A224F50454E415049222C22636F6D70"+
        "616E79436F6465223A2232303231303033313737363231303336222C22646576696365496E666F726D6174696F6E223A7B226465766963"+
        "65496D6569223A22646576696365496D6569222C226465766963654D6163223A226465766963654D6163222C22646576696365536E223A"+
        "226163666461613861376430643432633961666433316365663737616139396330227D2C226578747261506172616D73223A7B22666561"+
        "7475726573223A5B22414E545F464F5252455354222C225452414E53504F5254222C225041594D454E54225D7D2C2270726F647563744D"+
        "6F64656C223A224C58313030222C2270726F6475637454797065223A225741544348222C227075626C69634B6579223A222D2D2D2D2D42"+
        "4547494E205055424C4943204B45592D2D2D2D2D5C6E4D466B77457759484B6F5A497A6A3043415159494B6F5A497A6A30444151634451"+
        "674145316B2F6F6345365649686E664F304F794A654E614E424E3570784C475C6E613252437338527567697336303655416E50642B4A54"+
        "3239305859486236784555424961377A4252787654744D4936536F4A4F705651704451673D3D5C6E2D2D2D2D2D454E44205055424C4943"+
        "204B45592D2D2D2D2D5C6E222C2273656375726974794E65676F74696174696F6E223A2245434448222C227369676E223A226359657850"+
        "57326D766D67546D457075554C7555474A4B3856704C67512B6352496C477763597431544C3052764178765653462F423864417A2B7363"+
        "684F3531435173374641634D33646E64442B457A4E447078465A42316B316957336E684D50534864504B79737566613834787574376470"+
        "6C4C34446F555438726E2F5954476968336D4B7A73535A622B374A686D364747757A395075334A63706542704A4A2F4E624F413632725A"+
        "656D44654F6C37785642304B42586553756D5A71385573384F5634757666485A305551456E3833647753717253646273526D7266523467"+
        "76357A51686C704A5052416B6D304251644C62594A476B733974625354534E7569423638675A445A4A5433424C2B2B4A664D6D322F7945"+
        "33325263644149494A5277484956335965723962347263677A2B32324C54394532454744596A474D656D6C4E374569522B354F4F306949"+
        "504C73576873773D3D222C227369676E416C676F726974686D223A224241534536345F4F5645525F52534132303438222C22736E223A22"+
        "32303233313032303135303234303232383336353136227D7D";


		// let  credential = 
        // ' {"privateKey":"2f882b550c93246fddd48bd794b8b6d2aeec1902b07ee23c8883f726211d0057","success":true,
        // "deviceCertificate":{"certIssuer":"OPENAPI","companyCode":"2021003177621036","deviceInformation":{
        // "deviceImei":"deviceImei","deviceMac":"deviceMac","deviceSn":"acfdaa8a7d0d42c9afd31cef77aa99c0"},
        // "extraParams":{"features":["ANT_FORREST","TRANSPORT","PAYMENT"]},"productModel":"LX100",
        // "productType":"WATCH","publicKey":"-----BEGIN PUBLIC "
        // "KEY-----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE1k/"
        // "ocE6VIhnfO0OyJeNaNBN5pxLG\\na2RCs8Rugis606UAnPd+JT290XYHb6xEUBIa7zBRxvTtMI6SoJOpVQpDQg==\\n-----END PUBLIC "
        // "KEY-----\n\","securityNegotiation\":\"ECDH\",\"sign\":\"cYexPW2mvmgTmEpuULuUGJK8VpLgQ+cRIlGwcYt1TL0RvAxvVSF/"
        // "B8dAz+schO51CQs7FAcM3dndD+EzNDpxFZB1k1iW3nhMPSHdPKysufa84xut7dplL4DoUT8rn/YTGih3mKzsSZb+7Jhm6GGuz9Pu3JcpeBpJJ/"
        // "NbOA62rZemDeOl7xVB0KBXeSumZq8Us8OV4uvfHZ0UQEn83dwSqrSdbsRmrfR4gv5zQhlpJPRAkm0BQdLbYJGks9tbSTSNuiB68gZDZJT3BL++"
        // "JfMm2/"
        // "yE32RcdAIIJRwHIV3Yer9b4rcgz+22LT9E2EGDYjGMemlN7EiR+5OO0iIPLsWhsw==\",\"signAlgorithm\":\"BASE64_OVER_"
        // "RSA2048\",\"sn\":\"2023102015024022836516\"}} '


		let  credential =
        "{\"privateKey\":\"2f882b550c93246fddd48bd794b8b6d2aeec1902b07ee23c8883f726211d0057\",\"success\":true," +
        "\"deviceCertificate\":{\"certIssuer\":\"OPENAPI\",\"companyCode\":\"2021003177621036\",\"deviceInformation\":{" +
        "\"deviceImei\":\"deviceImei\",\"deviceMac\":\"deviceMac\",\"deviceSn\":\"acfdaa8a7d0d42c9afd31cef77aa99c0\"},"+
        "\"extraParams\":{\"features\":[\"ANT_FORREST\",\"TRANSPORT\",\"PAYMENT\"]},\"productModel\":\"LX100\","+
        "\"productType\":\"WATCH\",\"publicKey\":\"-----BEGIN PUBLIC "+
        "KEY-----\\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE1k/"+
        "ocE6VIhnfO0OyJeNaNBN5pxLG\\na2RCs8Rugis606UAnPd+JT290XYHb6xEUBIa7zBRxvTtMI6SoJOpVQpDQg==\\n-----END PUBLIC "+
        "KEY-----\\n\",\"securityNegotiation\":\"ECDH\",\"sign\":\"cYexPW2mvmgTmEpuULuUGJK8VpLgQ+cRIlGwcYt1TL0RvAxvVSF/"+
        "B8dAz+schO51CQs7FAcM3dndD+EzNDpxFZB1k1iW3nhMPSHdPKysufa84xut7dplL4DoUT8rn/YTGih3mKzsSZb+7Jhm6GGuz9Pu3JcpeBpJJ/"+
        "NbOA62rZemDeOl7xVB0KBXeSumZq8Us8OV4uvfHZ0UQEn83dwSqrSdbsRmrfR4gv5zQhlpJPRAkm0BQdLbYJGks9tbSTSNuiB68gZDZJT3BL++"+
        "JfMm2/"+
        "yE32RcdAIIJRwHIV3Yer9b4rcgz+22LT9E2EGDYjGMemlN7EiR+5OO0iIPLsWhsw==\",\"signAlgorithm\":\"BASE64_OVER_"+
        "RSA2048\",\"sn\":\"2023102015024022836516\"}}";

		let isnew = 0

		let result = libkp.csigenkey(cid,huk,credential,isnew)
		if (result != "") {
			console.log("csi_generate_key_provision succed to call:\n")
			console.log(`csi_generate_key_provision return kp length:${result.length}\n`, result.toString())
			console.log("\n")
			console.log(`csi_generate_key_provision expect_old kp length:${expect_old.length}\n`,expect_old)
			console.log("\n")

			if (result === expect_old ){
				
				console.log("csi_generate_key_provision kp 一致:\n")
			}

		} else {
			console.error('failed to csi_generate_key_provision error:', result)
		}

		isnew = 1

		let newresult = libkp.csigenkey(cid,huk,credential,isnew)
		if (newresult != "") {
			console.log("csigenkey succed to call:\n")
			console.log(`csigenkey return kp length:${newresult.length}\n`, newresult.toString())
			console.log("\n")
			console.log(`csigenkey expect_new kp length:${expect_new.length}\n`,expect_new)
			console.log("\n")

			if (newresult === expect_new ){
				
				console.log("csigenkey new kp 一致:\n")
			}

		} else {
			console.error('failed to csigenkey error:', newresult)
		}
	} catch (error) {
		console.error('Error csigenkey:', error)
	}
}

CsiGenerateKeyProvision()